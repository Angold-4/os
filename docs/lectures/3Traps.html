<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Angold-4 Organization</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="../../../images/favicon.png" rel="icon">

<link rel="canonical" href=".">
        <meta name="author" content="Angold Wang" />

    <meta property="og:site_name" content="Angold-4" />
<!--     <meta property="og:type" content="article"/> -->
    <meta property="og:title" content="Angold-4 Organization"/>
    <meta property="og:url" content="."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../../theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="../../../theme/css/font-awesome.min.css" rel="stylesheet">
<!--     <link href="https://cdnjs.cloudflare.com/ajax/libs/typicons/2.0.9/typicons.min.css" rel="stylesheet"> -->

    <link href="../../../theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../theme/css/style.css" type="text/css"/>

</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script> -->

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://angold4.org" class="navbar-brand">
<img src="../../../images/logo.png" width="32"/> Angold4            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
			    <li><a href="../../../about.html">About</a>
                            <li><a href="../../../blogs.html">Blogs</a>
                            <li><a href="../../../projects.html">Projects</a>

	    </ul>
            <ul class="nav navbar-nav navbar-right">
                <li> <a title="Youtube" href="https://www.youtube.com/channel/UC3ZAjh2LHhm-FrgxgBtgMzQ" target="_new"><i class="fa fa-youtube"></i> Youtube</a>
		</li>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->


<div class="container">
    <div class="row">
        <div class="col-lg-12">
	<section id="content" class="body">


<h1>3. Special Topic: Traps</h1>
<h5>03/06/2022 By Angold Wang</h5>
<p>There are three kinds of event which cause the CPU to set aside ordinary execution of instructions and force a transfer of control to special code that handles the event:</p>
<ol>
<li><strong>System Call:</strong> When a user program executes the <strong><code>ecall</code></strong> instruction to ask the kernel to do something for it.</li>
<li><strong>Exception:</strong> When an instruction (user/kernel) does something illegal, such as divide by zero or use an invalid virtual address.</li>
</ol>
<ul>
<li><strong>Interrupt:</strong> When a device signals that it needs attention.</li>
</ul>
<p><strong>Trap is a generic term for these situations.</strong>
Typically, whatever code was executing at the time of the trap will later need to resume, and shouldn't need to be aware that anything special happends.</p>
<p><strong>In this topic, we'll step into the actual <code>xv6</code> code and check the details of how traps were implemented by walking through a whole <code>SYS_write</code> system call procedule when we booting the <code>xv6</code>.</strong></p>
<h2>0. Boot xv6</h2>
<p>When the RISC-V computer powers on. It initializes itself and runs a boot loader which is stored in read-only memory. The boot loader loads the xv6 kernel into memory.</p>
<p>The loader loads the xv6 kernel into memory at physical address <strong><code>0x80000000</code></strong>. The reason it places the kernel at <strong><code>0x80000000</code></strong> rather than <strong><code>0x0</code></strong> is because the address range <strong><code>0x0:0x80000000</code></strong> contains I/O devices.</p>
<p><img src="Sources/addressxv6.png" alt="addressxv6"></p>
<h3>i. <code>_entry</code></h3>
<p>Then in <strong>machine mode</strong>. The CPU executes xv6 starting at <code>_entry</code> <strong>(kernel/entry.s)</strong></p>
<pre><code class="language-asm">    # qemu -kernel loads the kernel at 0x80000000
    # and causes each CPU to jump there.
    # kernel.ld causes the following code to
    # be placed at 0x80000000.
.section .text
.global _entry
_entry:
	# set up a stack for C.
        # stack0 is declared in start.c,
        # with a 4096-byte stack per CPU.
        # sp = stack0 + (hartid * 4096)
        la sp, stack0
        li a0, 1024*4
        csrr a1, mhartid
        addi a1, a1, 1
        mul a0, a0, a1
        add sp, sp, a0
	# jump to start() in start.c
        call start
spin:
        j spin

</code></pre>
<p><strong>Basically, this piece of code does two things:</strong></p>
<ol>
<li><strong>Set up a stack so that xv6 can run C code. and set the stack pointer <code>%sp</code> with the address <code>stack0 + 4096</code>.</strong>
<ul>
<li>Set the stack in order to let xv6 run C code</li>
<li>The <code>stack0</code> is defined in <code>kernel/start.c</code>, which is the initial stack of xv6.</li>
</ul>
</li>
<li><strong>Then calls into C code at <code>start</code> at <code>kernel/start.c</code></strong></li>
</ol>
<h3>ii. <code>start</code></h3>
<pre><code class="language-c">// entry.S jumps here in machine mode on stack0.
void
start()
{
  // set M Previous Privilege mode to Supervisor, for mret.
  unsigned long x = r_mstatus();
  x &amp;= ~MSTATUS_MPP_MASK;
  x |= MSTATUS_MPP_S;
  w_mstatus(x);

  // set M Exception Program Counter to main, for mret.
  // requires gcc -mcmodel=medany
  w_mepc((uint64)main);

  // disable paging for now.
  w_satp(0);

  // delegate all interrupts and exceptions to supervisor mode.
  w_medeleg(0xffff);
  w_mideleg(0xffff);
  w_sie(r_sie() | SIE_SEIE | SIE_STIE | SIE_SSIE);

  // configure Physical Memory Protection to give supervisor mode
  // access to all of physical memory.
  w_pmpaddr0(0x3fffffffffffffull);
  w_pmpcfg0(0xf);

  // ask for clock interrupts.
  timerinit();

  // keep each CPU's hartid in its tp register, for cpuid().
  int id = r_mhartid();
  w_tp(id);

  // switch to supervisor mode and jump to main().
  asm volatile(&quot;mret&quot;);
}
</code></pre>
<p><strong>Machine Mode vs. Supervisor Mode</strong>: Machine mode has access to all the hardware features but does not have virtual-memory support.</p>
<ol>
<li><strong>Writing <code>main</code>'s address into register <code>%mepc</code> in order to return to <code>main</code> after <code>start</code> finished</strong></li>
<li><strong>Writing <code>0</code> into the page-table register <code>satp</code> in order to disables virtual address translation</strong> (we haven't set the page table yet).</li>
<li>Program the clock chip to generate clock interrupt (0.1s).</li>
</ol>
<p>Although we haven't set any page table yet (even for kernel page table), we still can access some physical memory. The reason is that &quot;<strong>Identical Mapping</strong>&quot; in xv6, which  <strong>mapping the resources at virtual address between <code>0x80000000</code> to <code>0x86400000</code> that are equal to the physical address.</strong></p>
<h3>iii. <code>main</code></h3>
<pre><code class="language-c">// start() jumps here in supervisor mode on all CPUs.
void
main()
{
  if(cpuid() == 0){
    consoleinit();
    printfinit();
    printf(&quot;\n&quot;);
    printf(&quot;xv6 kernel is booting\n&quot;);
    printf(&quot;\n&quot;);
    kinit();         // physical page allocator
    kvminit();       // create kernel page table
    kvminithart();   // turn on paging
    procinit();      // process table
    trapinit();      // trap vectors
    trapinithart();  // install kernel trap vector
    plicinit();      // set up interrupt controller
    plicinithart();  // ask PLIC for device interrupts
    binit();         // buffer cache
    iinit();         // inode table
    fileinit();      // file table
    virtio_disk_init(); // emulated hard disk
    userinit();      // first user process
    __sync_synchronize();
    started = 1;
  } else {
    while(started == 0)
      ;
    __sync_synchronize();
    printf(&quot;hart %d starting\n&quot;, cpuid());
    kvminithart();    // turn on paging
    trapinithart();   // install kernel trap vector
    plicinithart();   // ask PLIC for device interrupts
  }

  scheduler();        
}

</code></pre>
<h2>1. ecall</h2>
<h2>2. Trampoline</h2>
	</section>
	</div>
    </div>
</div>
<footer>
   <div class="well well-lg" id="footer-well">
      <div class="container">


      <div class="row">
         <div class="col-xs-6">
            <a href="https://angold4.org" title="Angold-4 Organization" class="image-link"><img src="../../../images/logo.png" class="cmudb-logo" /></a>
         </div>
         <div class="col-xs-6">
            <p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p>
        </div>
      </div>
   </div>
   </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../theme/js/respond.min.js"></script>

<!-- Fix scrolling issues to internal HREFs that get positioned behind navbar -->
<!-- http://stackoverflow.com/questions/10732690/offsetting-an-html-anchor-to-adjust-for-fixed-header -->
<script src="../../../theme/js/href_scroll.js"></script>

<!-- You know what this is and you know what he did to me... -->
<script src="../../../theme/js/tim-kraska-betrayed-me.js"></script>
</body>
</html>
