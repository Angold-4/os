<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Angold-4 Organization</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="../../../images/favicon.png" rel="icon">

<link rel="canonical" href=".">
        <meta name="author" content="Angold Wang" />

    <meta property="og:site_name" content="Angold-4" />
<!--     <meta property="og:type" content="article"/> -->
    <meta property="og:title" content="Angold-4 Organization"/>
    <meta property="og:url" content="."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../../theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="../../../theme/css/font-awesome.min.css" rel="stylesheet">
<!--     <link href="https://cdnjs.cloudflare.com/ajax/libs/typicons/2.0.9/typicons.min.css" rel="stylesheet"> -->

    <link href="../../../theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../theme/css/style.css" type="text/css"/>

</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script> -->

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://angold4.org" class="navbar-brand">
<img src="../../../images/logo.png" width="32"/> Angold4            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
			    <li><a href="../../../about.html">About</a>
                            <li><a href="../../../blogs.html">Blogs</a>
                            <li><a href="../../../projects.html">Projects</a>

	    </ul>
            <ul class="nav navbar-nav navbar-right">
                <li> <a title="Youtube" href="https://www.youtube.com/channel/UC3ZAjh2LHhm-FrgxgBtgMzQ" target="_new"><i class="fa fa-youtube"></i> Youtube</a>
		</li>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->


<div class="container">
    <div class="row">
        <div class="col-lg-12">
	<section id="content" class="body">



<h1>File System (ii)</h1>
<h5>05/25/2022 By Angold Wang</h5>
<p><img src="Sources/fslayer.png" alt="fslayer"></p>
<h2>3. Inode and Path</h2>
<p><strong>Up until log, these lower layers are all interacting with disk blocks (sectors) with a specific <code>blockno</code>.</strong> But in the file systems that we are using in our daily life, seems that we are manipulating data on specific <strong>files</strong>, and finding them using <strong>path names</strong>.</p>
<p>The upper layers (layer 4, 5, 6, 7) is trying to ease the user by providing <strong>path, file, directory, etc,</strong> which we are familar with.</p>
<h3>i. Block Allocator</h3>
<p>File and directory is stored in <strong>disk blocks</strong>, which must be allocated from a free pool. Xv6's block allocator maintains a <strong>bitmap</strong> on disk, <strong>with one bit per block.</strong> A zero bit indicates that the corresponding block is free; a one bit indicates that it is in use.</p>
<p>The main API function that the block allocator provided is <strong><code>balloc()</code></strong> which allocates a new disk block and return its <strong><code>blockno</code></strong>. The loop inside <code>balloc</code> is split into two pieces:</p>
<ul>
<li>The outer loop reads each block of bitmap bits (on disk).</li>
<li><strong>The inner loop checks all Bits-Per-Block(BPB) bits in a single bitmap block.</strong></li>
</ul>
<p>The loop looks for a block whose bitmap bit is zero, indicating that it is free. If <strong><code>balloc</code></strong> finds such a block, it updates the block and writes it to the disk (<code>log_write</code>) then return the <code>blockno</code> of that block.</p>
<pre><code class="language-c">// kernel/fs.c:
  for(b = 0; b &lt; sb.size; b += BPB){
    // for each bitmap block
    bp = bread(dev, BBLOCK(b, sb));
    for(bi = 0; bi &lt; BPB &amp;&amp; b + bi &lt; sb.size; bi++){
      m = 1 &lt;&lt; (bi % 8);
      if((bp-&gt;data[bi/8] &amp; m) == 0){  // Is block free?
        bp-&gt;data[bi/8] |= m;  // Mark block in use.
        log_write(bp); // write to the log buffer (bitmap -&gt; disk)
        brelse(bp);
        bzero(dev, b + bi);
        return b + bi;
      }
    }
  }
</code></pre>
<h3>ii. Inode</h3>
<h3>iii. Directory</h3>
<h3>iv. Path Name</h3>
<h3>v. File Descriptor</h3>
<h2>4. System Calls</h2>
	</section>
	</div>
    </div>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
this.page.url = "https://angold4.org/os/docs/lectures/7FSii.html"
this.page.identifier = "os/docs/lectures/7FSii.html"

    };
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://angold.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
<footer>
   <div class="well well-lg" id="footer-well">
      <div class="container">


      <div class="row">
         <div class="col-xs-6">
            <a href="https://angold4.org" title="Angold-4 Organization" class="image-link"><img src="../../../images/logo.png" class="cmudb-logo" /></a>
         </div>
         <div class="col-xs-6">
            <p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p>
        </div>
      </div>
   </div>
   </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../theme/js/respond.min.js"></script>

<!-- Fix scrolling issues to internal HREFs that get positioned behind navbar -->
<!-- http://stackoverflow.com/questions/10732690/offsetting-an-html-anchor-to-adjust-for-fixed-header -->
<script src="../../../theme/js/href_scroll.js"></script>

<!-- You know what this is and you know what he did to me... -->
<script src="../../../theme/js/tim-kraska-betrayed-me.js"></script>
</body>
</html>

