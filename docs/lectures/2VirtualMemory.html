<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Angold-4 Organization</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="../../../images/favicon.png" rel="icon">
<link rel="canonical" href=".">
        <meta name="author" content="Angold Wang" />

    <meta property="og:site_name" content="Angold-4" />
<!--     <meta property="og:type" content="article"/> -->
    <meta property="og:title" content="Angold-4 Organization"/>
    <meta property="og:url" content="."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../../theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="../../../theme/css/font-awesome.min.css" rel="stylesheet">
<!--     <link href="https://cdnjs.cloudflare.com/ajax/libs/typicons/2.0.9/typicons.min.css" rel="stylesheet"> -->

    <link href="../../../theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../theme/css/style.css" type="text/css"/>

  <style>

    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }

    li {
      font-size: 18px;
    }

    p {
      font-size: 18px;
    }

    a {
      font-size: 18px;
    }

    k

    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }

    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }

    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
    {   }

    @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }

    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script> -->

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://angold4.org" class="navbar-brand">
<img src="../../../images/logo.png" width="32"/> Angold4            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
			    <li><a href="../../../about.html">About</a>
                            <li><a href="../../../blogs.html">Blogs</a>
                            <li><a href="../../../projects.html">Projects</a>

	    </ul>
            <ul class="nav navbar-nav navbar-right">
                <li> <a title="Youtube" href="https://www.youtube.com/channel/UC3ZAjh2LHhm-FrgxgBtgMzQ" target="_new"><i class="fa fa-youtube"></i> Youtube</a>
		</li>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->


<div class="container">
    <div class="row">
        <div class="col-lg-12">
	<section id="content" class="body">
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#virtual-memory" id="toc-virtual-memory">2. Virtual
Memory</a>
<ul>
<li><a href="#kernel-with-isolation"
id="toc-kernel-with-isolation">Kernel with “Isolation”</a></li>
<li><a href="#memory-isolation" id="toc-memory-isolation">1. Memory
Isolation</a></li>
<li><a href="#paging-hardware" id="toc-paging-hardware">2. Paging
Hardware</a>
<ul>
<li><a href="#i.-level-of-indirection-indexing"
id="toc-i.-level-of-indirection-indexing">i. Level of Indirection
Indexing</a></li>
<li><a href="#ii.-virtual-address-to-page"
id="toc-ii.-virtual-address-to-page">ii. Virtual Address to
Page</a></li>
<li><a href="#iii.-page-to-page-directory"
id="toc-iii.-page-to-page-directory">iii. Page to Page
Directory</a></li>
</ul></li>
<li><a href="#page-table-implementation-in-xv6"
id="toc-page-table-implementation-in-xv6">3. Page Table Implementation
in xv6</a>
<ul>
<li><a href="#i.-initialize" id="toc-i.-initialize">i.
Initialize</a></li>
<li><a href="#ii.-code-walk" id="toc-ii.-code-walk">ii. Code:
<code>walk()</code></a></li>
</ul></li>
<li><a href="#advanced-topic-in-virtual-memory"
id="toc-advanced-topic-in-virtual-memory">4. Advanced Topic in Virtual
Memory</a>
<ul>
<li><a href="#i.-kernel-page-table-per-user-process"
id="toc-i.-kernel-page-table-per-user-process">i. Kernel Page Table Per
User Process</a></li>
<li><a href="#ii.-lazy-page-allocation"
id="toc-ii.-lazy-page-allocation">ii. Lazy Page Allocation</a></li>
<li><a href="#iii.-copy-on-write" id="toc-iii.-copy-on-write">iii.
Copy-on-Write</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="virtual-memory">2. Virtual Memory</h1>
<h5 id="by-angold-wang">03/03/2022 By Angold Wang</h5>
<h3 id="kernel-with-isolation">Kernel with “Isolation”</h3>
<ul>
<li><strong>Restrict each user processes so that all it can do is
read/write/execute its own user memory, and use the 32 gerneral-purpose
RISC-V registers.</strong></li>
<li><strong>One user-process can only affect the kernel and other
processes in the ways that system calls are intended to
allow</strong></li>
</ul>
<h2 id="memory-isolation">1. Memory Isolation</h2>
<p>The RISC-V instructions (both user and kernel)
<strong>manipulate</strong> <strong>virtual addresses</strong>. But
machine’s RAM, or physical memory, is indexed with <strong>physical
addresses</strong>.</p>
<p>In the <strong><a
href="https://a4org.github.io/os/docs/lectures/1Introduction.html">last</a></strong>
note, we mentioned that one way to bring isolation is through
<strong>Virtual Memory</strong>. The main purpose of <strong>Virtual
Memory</strong> is to achieve <strong>strong Memory
Isolation</strong>.</p>
<ul>
<li>Each process has its own memory</li>
<li>It can read and write its own memory</li>
<li>It cannot read or write anything else directly (must through
syscall, with privileges)</li>
<li><strong>Each process believes that they have full memory space under
control</strong> (Two processes with “same” virtual address)</li>
</ul>
<figure>
<img src="Sources/pvview.png" alt="pvview" />
<figcaption aria-hidden="true">pvview</figcaption>
</figure>
<p>How to multiplex several memories over one physical memory? while
maintaining isolation between memories.</p>
<figure>
<img src="Sources/memlayout.png" alt="memlayout" />
<figcaption aria-hidden="true">memlayout</figcaption>
</figure>
<h2 id="paging-hardware">2. Paging Hardware</h2>
<h3 id="i.-level-of-indirection-indexing">i. Level of Indirection
Indexing</h3>
<figure>
<img src="Sources/lii.png" alt="lii" />
<figcaption aria-hidden="true">lii</figcaption>
</figure>
<ul>
<li>Software can only read and write to virtual memory.</li>
<li>Only kernel can program mmu (Memory Manage Unit), <strong>which
means this VA -&gt; PA mapping is completely under the control of the
Operating System.</strong></li>
<li>MMU has a <strong>Page table</strong> that maps virtual addresses to
physical adresses.</li>
<li>Some virtual addresses restricted to kernel-only.</li>
</ul>
<h3 id="ii.-virtual-address-to-page">ii. Virtual Address to Page</h3>
<h4 id="why-we-need-page">Why we need page?</h4>
<p>Imagine that a <code>64-bit</code> machine, which means it support
<code>2^64</code> memory address, if we just simply map one
<strong>VA</strong> into one <strong>PA</strong>, the mapping table
continuous store in memory will be also <code>2^64</code> – which is
gigantic.</p>
<p><strong>So we use another way, instead store this mapping
relationship in a very gigantic continuous mapping array, we divide them
into different pages, and each virtual address contains two message:
<code>page_id</code> and <code>offset</code>.</strong></p>
<p><strong>Each process has its own <code>page_table</code>, which
managed by the kernel</strong>, here is the
<strong><code>proc</code></strong> structure in xv6:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> proc <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> spinlock lock<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// p-&gt;lock must be held when using these:</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">enum</span> procstate state<span class="op">;</span>        <span class="co">// Process state</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>chan<span class="op">;</span>                  <span class="co">// If non-zero, sleeping on chan</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> killed<span class="op">;</span>                  <span class="co">// If non-zero, have been killed</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> xstate<span class="op">;</span>                  <span class="co">// Exit status to be returned to parent&#39;s wait</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> pid<span class="op">;</span>                     <span class="co">// Process ID</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// wait_lock must be held when using this:</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> proc <span class="op">*</span>parent<span class="op">;</span>         <span class="co">// Parent process</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// these are private to the process, so p-&gt;lock need not be held.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  uint64 kstack<span class="op">;</span>               <span class="co">// Virtual address of kernel stack</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  uint64 sz<span class="op">;</span>                   <span class="co">// Size of process memory (bytes)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  pagetable_t pagetable<span class="op">;</span>       <span class="co">// User page table (Which table / start address)</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> trapframe <span class="op">*</span>trapframe<span class="op">;</span> <span class="co">// data page for trampoline.S</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> context context<span class="op">;</span>      <span class="co">// swtch() here to run process</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> file <span class="op">*</span>ofile<span class="op">[</span>NOFILE<span class="op">];</span>  <span class="co">// Open files</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> inode <span class="op">*</span>cwd<span class="op">;</span>           <span class="co">// Current directory</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> name<span class="op">[</span><span class="dv">16</span><span class="op">];</span>               <span class="co">// Process name (debugging)</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 id="high-level-view-of-xv6-page-table">High-level view of xv6 page
table</h4>
<p>xv6 runs on Sv39 RISC-V, which means that only the bottom
<code>39</code> bits of a 64-bit virtual address. <strong>A RISC-V page
table is logically an array of <code>2^27</code>
(<code>134,217,728</code>) page table entries (PTE). Each PTE contains a
<code>44-bit</code> physical page number (PPN) and <code>10-bit</code>
flags.</strong></p>
<figure>
<img src="Sources/abstractpage.png" alt="abstractpage" />
<figcaption aria-hidden="true">abstractpage</figcaption>
</figure>
<h3 id="iii.-page-to-page-directory">iii. Page to Page Directory</h3>
<p><strong>Revisted: Would it be reasonable for page table to just be an
array of PTEs?</strong> * <strong><code>2^27</code> is roughly
<code>134</code> millions</strong> * <strong><code>64</code> bits per
page entry</strong> * <strong><code>134 * 8bytes * million</code> for a
full page table</strong> * wasting roughly <code>1GB</code> per page
table * one page table per address space * one address space per
application * <strong>Would waste losts of memory for small
programs!</strong> * you only need mappings for a few hundred pages. *
so the rest of the million entries would be there but not needed</p>
<h4 id="satp-register">Satp Register</h4>
<p>Each CPU core has its own unique <strong><code>%satp</code></strong>
register, where store the current-running process’s page table starting
address of its CPU. That makes different CPUs can run different
processes, <strong>each with a private address space described by its
own page table.</strong></p>
<h4 id="level-page-table-page-directory">3-level page table (Page
Directory)</h4>
<p>As we see that above, it is not good to just simply have a giant page
table per process. In real translation at MMU, <strong>A page table is
stored in physical memory as a three-level tree. Each level is a page
directory, which is <code>4096 bytes</code>, and contains
<code>512 (2^9)</code> 64-bit page table entries. And that 3-level
<code>2^9</code> PTEs can be located via the first 27 bits virtual
address.</strong></p>
<figure>
<img src="Sources/mmu3level.png" alt="mmu3level" />
<figcaption aria-hidden="true">mmu3level</figcaption>
</figure>
<p>This three-level structure of above figure <strong>allows a
memory-efficient way of recording PTEs, which means in the 3-level page
table, you can leave a lot of entries empty.</strong></p>
<p>For example, if you leave the entry in the top level page table
directory empty, for those entries, you don’t have to create middle
level page tables or bottom level page tables at all. <strong>And then
we can allowcate these chunks on demand.</strong></p>
<h2 id="page-table-implementation-in-xv6">3. Page Table Implementation
in xv6</h2>
<p><strong>The kernel must allocate and free physical memory at run-time
for page tables, and it uses a very small <code>allocator</code> resides
in <code>kalloc.c</code> (<code>kernel/kalloc.c</code>) to do these
stuff.</strong></p>
<h3 id="i.-initialize">i. Initialize</h3>
<p>For simplicity, the allocator can only use physical memory between
<strong><code>KERNBASE (0x80000000L)</code></strong> and
<strong><code>PHYSTOP(0x86400000L)</code></strong> to allocate pages,
which is about 104MB. The xv6 assumes that the machine has 128 megabytes
of RAM.</p>
<p>The <strong><code>main</code></strong> calls
<strong><code>kinit</code></strong> to initialze the allocator.
<strong><code>kinit</code></strong> initialzes the free list
(<code>freelist</code>) to hold <strong>every pages</strong> in the
physical memory (104MB).</p>
<p><strong>A PTE can only refer to a physical address that is aligned on
a 4096-byte boundary (is a multiple of 4096).</strong></p>
<p>If some process need to shrink or grow its memory, it will call
syscall <strong><code>sbrk()</code></strong>. And this syscall will call
whether <strong><code>uvmalloc()</code></strong> or
<strong><code>uvmdealloc()</code></strong> in order to perform the task.
* <strong>To shrink the memory.</strong> The task is done by
<strong><code>kfree()</code></strong>, which append the unused memory
pages into the free list page by page. * <strong>To grow the
memory.</strong> The task is done by
<strong><code>kalloc()</code></strong>, which “pop” the number of pages
from the free list.</p>
<figure>
<img src="Sources/pgtbl.png" alt="pgtbl" />
<figcaption aria-hidden="true">pgtbl</figcaption>
</figure>
<h3 id="ii.-code-walk">ii. Code: <code>walk()</code></h3>
<p>If you want to study the actual implementation of xv6 Virtual Memory,
I highly recommend you to read these two functions:
<strong><code>walk()</code></strong> and
<strong><code>mappages()</code></strong>.</p>
<p>Since the allocator sometimes treats address as <strong>integers in
order to perform arithmetic on them</strong> (e.g., traversing all pages
by adding <code>PGSIZE</code>), and sometimes uses addresses as
<strong>pointers to read and write memory </strong>(e.g., manipulating
the <code>run</code> structure stored in each page), which makes the
code a little bit sophisticated.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Return the address of the PTE in page table pagetable</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">// that corresponds to virtual address va.  If alloc!=0,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">// create any required page-table pages.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">// The risc-v Sv39 scheme has three levels of page-table</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">// pages. A page-table page contains 512 64-bit PTEs.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">// A 64-bit virtual address is split into five fields:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">//   39..63 -- must be zero.</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   30..38 -- 9 bits of level-2 index.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   21..29 -- 9 bits of level-1 index.</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   12..20 -- 9 bits of level-0 index.</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">//    0..11 -- 12 bits of byte offset within the page.</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>pte_t <span class="op">*</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>walk<span class="op">(</span>pagetable_t pagetable<span class="op">,</span> uint64 va<span class="op">,</span> <span class="dt">int</span> alloc<span class="op">)</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>va <span class="op">&gt;=</span> MAXVA<span class="op">)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    panic<span class="op">(</span><span class="st">&quot;walk&quot;</span><span class="op">);</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> level <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> level <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span> level<span class="op">--)</span> <span class="op">{</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// pagetable -&gt; pointer</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    pte_t <span class="op">*</span>pte <span class="op">=</span> <span class="op">&amp;</span>pagetable<span class="op">[</span>PX<span class="op">(</span>level<span class="op">,</span> va<span class="op">)];</span> <span class="co">// 4096 bytes / 2^9  = 64 bits (a pte)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(*</span>pte <span class="op">&amp;</span> PTE_V<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      pagetable <span class="op">=</span> <span class="op">(</span>pagetable_t<span class="op">)</span>PTE2PA<span class="op">(*</span>pte<span class="op">);</span> <span class="co">// next pgtbl&#39;s begin address</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span><span class="op">(!</span>alloc <span class="op">||</span> <span class="op">(</span>pagetable <span class="op">=</span> <span class="op">(</span>pde_t<span class="op">*)</span>kalloc<span class="op">())</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>      memset<span class="op">(</span>pagetable<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> PGSIZE<span class="op">);</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span>pte <span class="op">=</span> PA2PTE<span class="op">(</span>pagetable<span class="op">)</span> <span class="op">|</span> PTE_V<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">&amp;</span>pagetable<span class="op">[</span>PX<span class="op">(</span><span class="dv">0</span><span class="op">,</span> va<span class="op">)];</span> <span class="co">// only need 9 bits to get a valid pte (64bits)</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <strong><code>walk()</code></strong> functions basically performs
so-called <strong>Software Translate</strong>, which return the
<strong>Level-0 pte of given virtual address in that page
table.</strong></p>
<p>This work usually is done by the <strong>MMU Hardware</strong>, with
the help of <code>satp</code> register. And is much faster than this
function. But sometimes the page table we need is not in the
<code>%satp</code> register. (e.g., the kernel wants to dereference the
user virtual address pointers that <strong><code>write()</code></strong>
system call passed).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create PTEs for virtual addresses starting at va that refer to</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">// physical addresses starting at pa. va and size might not</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">// be page-aligned. Returns 0 on success, -1 if walk() couldn&#39;t</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">// allocate a needed page-table page.</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>mappages<span class="op">(</span>pagetable_t pagetable<span class="op">,</span> uint64 va<span class="op">,</span> uint64 size<span class="op">,</span> uint64 pa<span class="op">,</span> <span class="dt">int</span> perm<span class="op">)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  uint64 a<span class="op">,</span> last<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  pte_t <span class="op">*</span>pte<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>size <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    panic<span class="op">(</span><span class="st">&quot;mappages: size&quot;</span><span class="op">);</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  a <span class="op">=</span> PGROUNDDOWN<span class="op">(</span>va<span class="op">);</span> <span class="co">// 0000 in the last (begin a page)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  last <span class="op">=</span> PGROUNDDOWN<span class="op">(</span>va <span class="op">+</span> size <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(;;){</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">((</span>pte <span class="op">=</span> walk<span class="op">(</span>pagetable<span class="op">,</span> a<span class="op">,</span> <span class="dv">1</span><span class="op">))</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="co">// software walk get the last(0) level pte</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(*</span>pte <span class="op">&amp;</span> PTE_V<span class="op">)</span> <span class="co">// last pte value</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      panic<span class="op">(</span><span class="st">&quot;mappages: remap&quot;</span><span class="op">);</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// the pte is a pointer, points to the real physical address</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>pte <span class="op">=</span> PA2PTE<span class="op">(</span>pa<span class="op">)</span> <span class="op">|</span> perm <span class="op">|</span> PTE_V<span class="op">;</span> <span class="co">// PTE</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>a <span class="op">==</span> last<span class="op">)</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    a <span class="op">+=</span> PGSIZE<span class="op">;</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    pa <span class="op">+=</span> PGSIZE<span class="op">;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <strong><code>mappages()</code></strong> creating mappings
between virtual and physical addresses. The <code>pagetable_t</code> is
a pointer, which points to the begin of a <code>4096</code> bytes
page.</p>
<h2 id="advanced-topic-in-virtual-memory">4. Advanced Topic in Virtual
Memory</h2>
<h3 id="i.-kernel-page-table-per-user-process">i. Kernel Page Table Per
User Process</h3>
<h3 id="ii.-lazy-page-allocation">ii. Lazy Page Allocation</h3>
<h3 id="iii.-copy-on-write">iii. Copy-on-Write</h3>
	</section>
	</div>
    </div>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
this.page.url = "https://angold4.org/os/docs/lectures/2VirtualMemory.html"
this.page.identifier = "os/docs/lectures/2VirtualMemory.html"

    };
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://angold.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
<footer>
   <div class="well well-lg" id="footer-well">
      <div class="container">


      <div class="row">
         <div class="col-xs-6">
            <a href="https://angold4.org" title="Angold-4 Organization" class="image-link"><img src="../../../images/logo.png" class="cmudb-logo" /></a>
         </div>
         <div class="col-xs-6">
            <p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p>
        </div>
      </div>
   </div>
   </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script src="../../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../theme/js/respond.min.js"></script>

<!-- Fix scrolling issues to internal HREFs that get positioned behind navbar -->
<!-- http://stackoverflow.com/questions/10732690/offsetting-an-html-anchor-to-adjust-for-fixed-header -->
<script src="../../../theme/js/href_scroll.js"></script>

<!-- You know what this is and you know what he did to me... -->
<script src="../../../theme/js/tim-kraska-betrayed-me.js"></script>
</body>
</html>

